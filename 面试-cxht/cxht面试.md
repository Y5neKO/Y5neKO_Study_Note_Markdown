# 内网渗透

思路：

看入手的当前机器是windows还是linux以及当前的用户，如果是低权限用户做提权处理

如果当前机器是windows，则使用常见的命令将当前机器进行完整信息收集，比如 dumphash，是否存在杀软，工具需不需要做免杀

之后看看当前机器是否在域内，在域内则进行常规的域渗透，不在域内则进行工作组渗透并嗅探是否存在域环境。

如果是在linux则ping当前linux的机器名看是否在域内，比如机器名test,在域内的化后 面会跟test.xxxx，xxxx指当前的域名，在域内的话，则看是否存在域管登录的情况， 如果有域管的话则看看能不能获取到域管的hash凭证，然后在linux向域控横向。不在 域内的话，则做网段嗅探，是否存在永恒之蓝这一类的漏洞。更多的可以攻击web服 务，获取更多的权限。

## NTLM认证流程



## Kerberos认证流程

1. Client向KDC中的AS（验证服务器）发起请求**AS_REQ**，内容是通过Client Hash加密的时间戳
2. AS先验证Client用户名是否在白名单且是否和声明的Client用户名相同（证明你是你），再通过储存在域控中的对应的Client Hash对**AS_REQ**进行解密，如果为合法的时间戳格式则校验成功；向Client返回**TGT**票据（TGS Ticket），使用krbtgt账户的Hash进行加密，内容为PAC（包括Client的sid和所在的组等）
3. Client凭借返回的**TGT**，向KDC中的TGS（票据分发服务器）发起对应服务的**TGS_REQ**请求（包含请求的服务名）
4. KDC使用krbtgt账户的Hash对**TGT_REQ**进行解密，如果结果正确则校验成功；向Client返回**ST**票据（Service Ticket），使用服务的Hash进行加密，内容同样为PAC（这一步不管用户有没有访问对应服务的权限，只要校验成功就返回ST票据）
5. Client凭借返回的**ST**，向对应服务发起请求
6. 服务使用自己的Hash对**ST**进行解密，如果结果正确则校验成功；通过解密得到的PAC向KDC询问是否有访问权限；域控解密PAC得到相关信息，再根据ACL判断是否具有访问权限；成功建立连接

## 黄金/白银票据

**黄金票据**就是通过拿到的域控权限，在第二步的时候生成伪造的TGT票据；**白银票据**就是通过拿到的域控权限，在第四步的时候生成伪造的ST票据

**区别**

黄金票据：直接从第三步开始；可以访问任何Kerberos的相关服务；需要与KDC和AS通信；通过krbtgt Hash进行加密；

白银票据：直接从第五步开始；只能访问ST对应的服务；只需要与对应服务进行通信；通过Service Hash进行加密；

## pth攻击

**原理**

后渗透过程中，如果已经拿到hash值，可以尝试破解密码，但是破解一般费时费力且不一定有结果；反观NTLM和Kerberos认证流程，第一步都是通过Client Hash来加密一段信息，然后域控再通过储存的Client Hash对其进行解密，中间并没有涉及到明文密码，因此我们可以直接提供hash值，就能完成整个加解密流程；因此成为pth攻击（pass the hash哈希传递攻击）

**利用条件**

- 未打补丁KB2871997
- 已经拿到足够权限的域成员hash
- 攻击主机同样存在该域成员

**流程**

- 使用mimikatz的pth功能，需要三个信息：域用户名，域名，域用户hash
- 命令：`sekurlsa::pth /user:Administrator /domain:Y5NEKOAD /ntlm:85dafeeae5eacd3be1e561eea0a064ca`
- 注入成功之后就会弹出携带